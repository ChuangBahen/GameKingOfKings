# Feature Specification: 套裝系統與裝備掉落機制

**Feature Branch**: `002-equipment-set-drop`
**Created**: 2025-12-30
**Status**: Draft
**Input**: 為遊戲裝備系統增加「套裝」概念，讓玩家可以收集同一套裝的多個部件來獲得額外加成。同時改進怪物掉落機制，讓普通怪物也有極低機率掉落裝備，而 Boss 則保持較高的裝備掉落率作為主要裝備來源。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 擊殺怪物獲得裝備掉落 (Priority: P1) MVP

玩家在遊戲中擊殺怪物時，有機率獲得裝備掉落。普通怪物有極低機率掉落裝備（增加驚喜感），而 Boss 則有較高機率掉落。

**Why this priority**: 這是核心遊戲循環的一部分。沒有掉落機制，套裝系統無法運作。

**Independent Test**: 擊殺多隻普通怪物和 Boss，驗證裝備有依據設計機率掉落，掉落訊息正確顯示。

**Acceptance Scenarios**:

1. **Given** 玩家擊殺一隻 Lv 1-5 的普通怪物，**When** 戰鬥結束結算掉落，**Then** 有 0.5% 機率掉落裝備
2. **Given** 玩家擊殺一隻 Lv 6-10 的普通怪物，**When** 戰鬥結束結算掉落，**Then** 有 1% 機率掉落裝備
3. **Given** 玩家擊殺一隻 Lv 11+ 的普通怪物，**When** 戰鬥結束結算掉落，**Then** 有 2% 機率掉落裝備
4. **Given** 玩家擊殺一隻 Boss，**When** 戰鬥結束結算掉落，**Then** 有 30-100% 機率掉落裝備（依 Boss 設定）
5. **Given** 裝備成功掉落，**When** 顯示掉落訊息，**Then** 使用金色文字突出顯示裝備名稱

---

### User Story 2 - 裝備品質系統 (Priority: P1)

裝備依據稀有度分為四個品質等級，不同品質以不同顏色顯示，讓玩家一眼辨識裝備價值。

**Why this priority**: 品質系統是裝備價值感知的基礎，也是掉落機率分層的依據。

**Independent Test**: 查看背包中不同品質的裝備，驗證各品質顯示對應顏色。

**Acceptance Scenarios**:

1. **Given** 玩家獲得 Common 品質裝備，**When** 在背包或裝備介面查看，**Then** 裝備名稱顯示為白色
2. **Given** 玩家獲得 Uncommon 品質裝備，**When** 在背包或裝備介面查看，**Then** 裝備名稱顯示為綠色
3. **Given** 玩家獲得 Rare 品質裝備，**When** 在背包或裝備介面查看，**Then** 裝備名稱顯示為藍色
4. **Given** 玩家獲得 Legendary 品質裝備，**When** 在背包或裝備介面查看，**Then** 裝備名稱顯示為紫色
5. **Given** 普通怪確定掉落裝備，**When** 決定品質，**Then** 機率為 Common 70% / Uncommon 25% / Rare 4.5% / Legendary 0.5%
6. **Given** Boss 確定掉落裝備，**When** 決定品質，**Then** 機率為 Common 10% / Uncommon 30% / Rare 45% / Legendary 15%

---

### User Story 3 - 套裝定義與識別 (Priority: P2)

裝備可以屬於某個套裝，玩家可以在裝備詳情中查看套裝資訊，了解該套裝包含哪些部件。

**Why this priority**: 套裝識別是套裝加成的前提，但需要先有裝備掉落才有意義。

**Independent Test**: 裝備一件套裝部件，查看裝備詳情顯示套裝名稱和部件清單。

**Acceptance Scenarios**:

1. **Given** 玩家裝備一件屬於「史萊姆套裝」的裝備，**When** 查看裝備詳情，**Then** 顯示「這是史萊姆套裝的一部分」
2. **Given** 玩家查看套裝部件裝備詳情，**When** 展開套裝資訊，**Then** 顯示該套裝所有部件名稱和玩家已擁有的件數
3. **Given** 玩家擁有套裝中的部分部件，**When** 查看套裝資訊，**Then** 已擁有的部件標記為已收集，未擁有的顯示為灰色

---

### User Story 4 - 套裝加成計算與啟用 (Priority: P2)

當玩家裝備的套裝部件數量達到門檻（2件、3件、4件/全套），自動啟用對應的套裝加成效果。

**Why this priority**: 套裝加成是套裝系統的核心價值，但需要先有套裝識別。

**Independent Test**: 穿戴同套裝的多件裝備，驗證套裝加成正確啟用並影響角色屬性。

**Acceptance Scenarios**:

1. **Given** 玩家裝備史萊姆套裝 2 件，**When** 計算角色屬性，**Then** HP+20 加成生效
2. **Given** 玩家裝備史萊姆套裝 3 件（全套），**When** 計算角色屬性，**Then** HP+20、MP+15、全屬性+2 加成全部生效
3. **Given** 玩家裝備森林獵人套裝 4 件（全套），**When** 計算角色屬性，**Then** 攻擊+5、敏捷+5、攻擊+10、暴擊+5% 加成全部生效
4. **Given** 玩家脫下一件套裝部件導致件數低於門檻，**When** 重新計算屬性，**Then** 對應階段的加成失效

---

### User Story 5 - 套裝加成 UI 顯示 (Priority: P3)

在角色屬性面板中，顯示當前啟用的套裝加成效果，讓玩家清楚了解套裝帶來的好處。

**Why this priority**: UI 顯示是使用者體驗優化，核心功能優先。

**Independent Test**: 穿戴套裝後查看角色面板，確認套裝加成有獨立區塊顯示。

**Acceptance Scenarios**:

1. **Given** 玩家有啟用中的套裝加成，**When** 查看角色屬性面板，**Then** 有獨立區塊顯示「套裝效果」及詳細加成
2. **Given** 玩家裝備的套裝件數不足啟用任何加成，**When** 查看角色屬性面板，**Then** 不顯示套裝效果區塊或顯示「無啟用套裝效果」

---

### Edge Cases

- 當背包已滿時掉落裝備 → 顯示「背包已滿，無法拾取 [裝備名稱]」，裝備不進入背包
- 當玩家脫下套裝部件時 → 立即重新計算套裝加成，可能降階或完全失去加成
- 當同一件裝備屬於多個套裝時 → 目前不支援，每件裝備最多只屬於一個套裝
- 當怪物沒有設定可掉落裝備時 → 走原有掉落表邏輯，不額外判定裝備掉落
- 當怪物等級剛好在邊界（如 Lv 5 和 Lv 6）→ 使用 <= 判斷，Lv 5 用 0.5%，Lv 6 用 1%
- 當套裝只有 3 件但玩家嘗試收集第 4 件 → 該套裝沒有 4 件效果，只計算到全套（3件）效果

## Requirements *(mandatory)*

### Functional Requirements

**裝備掉落機制**

- **FR-001**: 系統必須在怪物被擊殺時判定是否掉落裝備
- **FR-002**: 普通怪物裝備掉落率必須依據等級：Lv 1-5 為 0.5%、Lv 6-10 為 1%、Lv 11+ 為 2%
- **FR-003**: Boss 怪物裝備掉落率必須為 30-100%（依據怪物資料設定）
- **FR-004**: 裝備掉落時必須使用金色文字顯示掉落訊息 (建議色碼: #FFD700 或 TailwindCSS text-yellow-400)
- **FR-005**: 裝備掉落判定必須在現有掉落邏輯（材料、藥水）之後執行，不影響現有掉落

**裝備品質系統**

- **FR-006**: 裝備必須有品質屬性，分為 Common、Uncommon、Rare、Legendary 四級
- **FR-007**: 普通怪掉落裝備品質機率：Common 70%、Uncommon 25%、Rare 4.5%、Legendary 0.5%
- **FR-008**: Boss 掉落裝備品質機率：Common 10%、Uncommon 30%、Rare 45%、Legendary 15%
- **FR-009**: 裝備名稱必須依品質顯示顏色：白(Common)、綠(Uncommon)、藍(Rare)、紫(Legendary)

**套裝系統**

- **FR-010**: 裝備可以屬於一個套裝，透過套裝 ID 關聯
- **FR-011**: 套裝必須定義名稱、包含的部件清單、各階段加成效果
- **FR-012**: 套裝加成門檻為 2 件、3 件、4 件（或全套，依套裝定義）
- **FR-013**: 當玩家裝備的同套裝部件數達到門檻時，系統必須自動啟用對應加成
- **FR-014**: 當玩家脫下套裝部件時，系統必須立即重新計算套裝加成 (目標 100ms 內完成)
- **FR-015**: 套裝加成必須反映在角色屬性計算中（攻擊、防禦、HP、MP 等）
- **FR-016**: 裝備詳情必須顯示套裝資訊：套裝名稱、所需部件、各階段加成、已收集件數

### Key Entities

- **EquipmentSet（套裝）**: 定義一組相關裝備，包含套裝 ID、名稱、所屬部件 ID 清單
- **SetBonus（套裝加成）**: 定義套裝在特定件數門檻的加成效果，包含套裝 ID、所需件數、加成屬性與數值
- **Item.Quality（裝備品質）**: 裝備的稀有度等級，影響顯示顏色
- **Item.SetId（套裝關聯）**: 裝備所屬的套裝 ID，可為空（非套裝裝備）
- **Monster.EquipmentDropRate（裝備掉落率）**: 怪物掉落裝備的基礎機率，Boss 可個別設定
- **Monster.DroppableEquipmentIds（可掉落裝備清單）**: 怪物可掉落的裝備 ID 清單

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 普通怪物裝備掉落率符合設計（0.5%/1%/2%），統計 1000 次擊殺誤差在 ±20% 內
- **SC-002**: Boss 裝備掉落率符合設計（30-100%），統計 100 次擊殺誤差在 ±10% 內
- **SC-003**: 裝備品質分佈符合設計機率，統計 100 件掉落裝備誤差在 ±30% 內
- **SC-004**: 套裝加成在裝備/脫下後 100ms 內正確反映在角色屬性
- **SC-005**: 所有品質的裝備在 UI 中顯示正確的對應顏色
- **SC-006**: 套裝資訊在裝備詳情中完整顯示，包含所有部件和加成效果
- **SC-007**: 現有掉落系統（材料、藥水）功能不受影響，原有掉落正常運作

## Assumptions

- 使用現有的 Item 模型，透過新增欄位擴展（Quality、SetId）
- 使用現有的 LootTableEntry 模型，裝備掉落為獨立邏輯
- 套裝資料將以種子資料方式初始化（史萊姆套裝、森林獵人套裝等）
- 前端已有裝備面板和背包 UI，需擴展顯示品質顏色和套裝資訊
- 暴擊率加成需要戰鬥系統支援暴擊計算（如果尚未實作，此為依賴）
